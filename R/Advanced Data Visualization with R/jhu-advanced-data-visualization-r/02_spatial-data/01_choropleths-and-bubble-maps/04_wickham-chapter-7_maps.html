<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>6 Maps | ggplot2</title>
<meta name="author" content="Hadley Wickham, Danielle Navarro, and Thomas Lin Pedersen">
<meta name="generator" content="bookdown 0.25 with bs4_book()">
<meta property="og:title" content="6 Maps | ggplot2">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="6 Maps | ggplot2">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-142542392-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-142542392-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="Plotting geospatial data is a common visualisation task, and one that requires specialised tools. Typically the problem can be decomposed into two problems: using one data source to draw a map,...">
<meta property="og:description" content="Plotting geospatial data is a common visualisation task, and one that requires specialised tools. Typically the problem can be decomposed into two problems: using one data source to draw a map,...">
<meta name="twitter:description" content="Plotting geospatial data is a common visualisation task, and one that requires specialised tools. Typically the problem can be decomposed into two problems: using one data source to draw a map,...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="Elegant Graphics for Data Analysis">ggplot2</a>:
        <small class="text-muted">Elegant Graphics for Data Analysis</small>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Welcome</a></li>
<li><a class="" href="preface-3e.html">Preface to the third edition</a></li>
<li><a class="" href="preface-to-the-second-edition.html">Preface to the second edition</a></li>
<li class="book-part">Getting started</li>
<li><a class="" href="introduction.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="getting-started.html"><span class="header-section-number">2</span> First steps</a></li>
<li class="book-part">Layers</li>
<li><a class="" href="toolbox.html">Introduction</a></li>
<li><a class="" href="individual-geoms.html"><span class="header-section-number">3</span> Individual geoms</a></li>
<li><a class="" href="collective-geoms.html"><span class="header-section-number">4</span> Collective geoms</a></li>
<li><a class="" href="statistical-summaries.html"><span class="header-section-number">5</span> Statistical summaries</a></li>
<li><a class="active" href="maps.html"><span class="header-section-number">6</span> Maps</a></li>
<li><a class="" href="networks.html"><span class="header-section-number">7</span> Networks</a></li>
<li><a class="" href="annotations.html"><span class="header-section-number">8</span> Annotations</a></li>
<li><a class="" href="arranging-plots.html"><span class="header-section-number">9</span> Arranging plots</a></li>
<li class="book-part">Scales</li>
<li><a class="" href="scales.html">Introduction</a></li>
<li><a class="" href="scale-position.html"><span class="header-section-number">10</span> Position scales and axes</a></li>
<li><a class="" href="scale-colour.html"><span class="header-section-number">11</span> Colour scales and legends</a></li>
<li><a class="" href="scale-other.html"><span class="header-section-number">12</span> Other aesthetics</a></li>
<li class="book-part">The Grammar</li>
<li><a class="" href="mastery.html"><span class="header-section-number">13</span> Mastering the grammar</a></li>
<li><a class="" href="layers.html"><span class="header-section-number">14</span> Build a plot layer by layer</a></li>
<li><a class="" href="scales-guides.html"><span class="header-section-number">15</span> Scales and guides</a></li>
<li><a class="" href="coord.html"><span class="header-section-number">16</span> Coordinate systems</a></li>
<li><a class="" href="facet.html"><span class="header-section-number">17</span> Faceting</a></li>
<li><a class="" href="polishing.html"><span class="header-section-number">18</span> Themes</a></li>
<li class="book-part">Extending ggplot2</li>
<li><a class="" href="programming.html"><span class="header-section-number">19</span> Programming with ggplot2</a></li>
<li><a class="" href="internals.html"><span class="header-section-number">20</span> ggplot2 internals</a></li>
<li><a class="" href="extensions.html"><span class="header-section-number">21</span> Writing ggplot2 extensions</a></li>
<li><a class="" href="spring1.html"><span class="header-section-number">22</span> Case Study: Springs</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/hadley/ggplot2-book">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="maps" class="section level1">
<h1>
<span class="header-section-number">6</span> Maps<a class="anchor" aria-label="anchor" href="#maps"><i class="fas fa-link"></i></a>
</h1>
<p>Plotting geospatial data is a common visualisation task, and one that requires specialised tools. Typically the problem can be decomposed into two problems: using one data source to draw a map, and adding metadata from another information source to the map. This chapter will help you tackle both problems. I’ve structured the chapter in the following way: Section <a href="maps.html#polygonmaps">6.1</a> outlines a simple way to draw maps using <code><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html">geom_polygon()</a></code>, which is followed in Section <a href="maps.html#sf">6.2</a> by a modern “simple features” (sf) approach using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code>. Next, Sections <a href="maps.html#mapproj">6.3</a> and <a href="maps.html#sfdetail">6.4</a> discuss how to work with map projections and the underlying sf data structure. Finally, Section <a href="maps.html#rastermaps">6.5</a> discusses how to draw maps based on raster data.</p>
<div id="polygonmaps" class="section level2">
<h2>
<span class="header-section-number">6.1</span> Polygon maps<a class="anchor" aria-label="anchor" href="#polygonmaps"><i class="fas fa-link"></i></a>
</h2>
<p>

</p>
<p>Perhaps the simplest approach to drawing maps is to use <code><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html">geom_polygon()</a></code> to draw boundaries for different regions. For this example we take data from the maps package using <code><a href="https://ggplot2.tidyverse.org/reference/map_data.html">ggplot2::map_data()</a></code>. The maps package isn’t particularly accurate or up-to-date, but it’s built into R so it’s an easy place to start. Here’s a data set specifying the county boundaries for Michigan:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mi_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/map_data.html">map_data</a></span><span class="op">(</span><span class="st">"county"</span>, <span class="st">"michigan"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>lon <span class="op">=</span> <span class="va">long</span>, <span class="va">lat</span>, <span class="va">group</span>, id <span class="op">=</span> <span class="va">subregion</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mi_counties</span><span class="op">)</span>
<span class="co">#&gt;     lon  lat group     id</span>
<span class="co">#&gt; 1 -83.9 44.9     1 alcona</span>
<span class="co">#&gt; 2 -83.4 44.9     1 alcona</span>
<span class="co">#&gt; 3 -83.4 44.9     1 alcona</span>
<span class="co">#&gt; 4 -83.3 44.8     1 alcona</span>
<span class="co">#&gt; 5 -83.3 44.8     1 alcona</span>
<span class="co">#&gt; 6 -83.3 44.8     1 alcona</span></code></pre></div>
<p>In this data set we have four variables: <code>lat</code> and <code>long</code> specify the latitude and longitude of a vertex (i.e. a corner of the polygon), <code>id</code> specifies the name of a region, and <code>group</code> provides a unique identifier for contiguous areas within a region (e.g. if a region consisted of multiple islands). To get a better sense of what the data contains, we can plot <code>mi_counties</code> using <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point()</a></code>, as shown in the left panel below. In this plot, each row in the data frame is plotted as a single point, producing a scatterplot that shows the corners of every county. To turn this scatterplot into a map, we use <code><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html">geom_polygon()</a></code> instead, which draws each county as a distinct polygon. This is illustrated in the right panel below.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">.25</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, group <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html">geom_polygon</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, colour <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="maps_files/figure-html/unnamed-chunk-2-1.png" width="50%" style="max-width: 3in"><img src="maps_files/figure-html/unnamed-chunk-2-2.png" width="50%" style="max-width: 3in"></p>
<p>In both plots I use <code><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap()</a></code> to adjust the axes to ensure that longitude and latitude are rendered on the same scale. Chapter <a href="coord.html#coord">16</a> discusses coordinate systems in ggplot2 in more general terms, but as we’ll see below, geospatial data often require a more exacting approach. For this reason, ggplot2 provides <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> to handle spatial data specified in simple features format.</p>
</div>
<div id="sf" class="section level2">
<h2>
<span class="header-section-number">6.2</span> Simple features maps<a class="anchor" aria-label="anchor" href="#sf"><i class="fas fa-link"></i></a>
</h2>
<p>There are a few limitations to the approach outlined above, not least of which is the fact that the simple “longitude-latitude” data format is not typically used in real world mapping. Vector data for maps are typically encoded using the “simple features” standard produced by the Open Geospatial Consortium. The sf package<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Edzer Pebesma, “Simple Features for R: Standardized Support for Spatial Vector Data,” &lt;em&gt;The R Journal&lt;/em&gt; 10, no. 1 (2018): 439–46, &lt;a href="https://doi.org/10.32614/RJ-2018-009" role="doc-biblioref"&gt;https://doi.org/10.32614/RJ-2018-009&lt;/a&gt;.&lt;/p&gt;'><sup>19</sup></a></span> developed by Edzer Pebesma <a href="https://github.com/r-spatial/sf" class="uri">https://github.com/r-spatial/sf</a> provides an excellent toolset for working with such data, and the <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> functions in ggplot2 are designed to work together with the sf package.</p>
<p>To introduce these functions, we rely on the ozmaps package by Michael Sumner <a href="https://github.com/mdsumner/ozmaps/" class="uri">https://github.com/mdsumner/ozmaps/</a> which provides maps for Australian state boundaries, local government areas, electoral boundaries, and so on.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Michael Sumner, &lt;em&gt;Ozmaps: Australia Maps&lt;/em&gt;, 2019, &lt;a href="https://CRAN.R-project.org/package=ozmaps" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=ozmaps&lt;/a&gt;.&lt;/p&gt;'><sup>20</sup></a></span> To illustrate what an sf data set looks like, we import a data set depicting the borders of Australian states and territories:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mdsumner/ozmaps">ozmaps</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>

<span class="va">oz_states</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/ozmap_states.html">ozmap_states</a></span>
<span class="va">oz_states</span>
<span class="co">#&gt; Simple feature collection with 9 features and 1 field</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 106 ymin: -43.6 xmax: 168 ymax: -9.23</span>
<span class="co">#&gt; Geodetic CRS:  GDA94</span>
<span class="co">#&gt; # A tibble: 9 × 2</span>
<span class="co">#&gt;   NAME                                                                  geometry</span>
<span class="co">#&gt; * &lt;chr&gt;                                                       &lt;MULTIPOLYGON [°]&gt;</span>
<span class="co">#&gt; 1 New South Wales   (((151 -35.1, 151 -35.1, 151 -35.1, 151 -35.1, 151 -35.2, 1…</span>
<span class="co">#&gt; 2 Victoria          (((147 -38.7, 147 -38.7, 147 -38.7, 147 -38.7, 147 -38.7)),…</span>
<span class="co">#&gt; 3 Queensland        (((149 -20.3, 149 -20.4, 149 -20.4, 149 -20.3)), ((149 -20.…</span>
<span class="co">#&gt; 4 South Australia   (((137 -34.5, 137 -34.5, 137 -34.5, 137 -34.5, 137 -34.5, 1…</span>
<span class="co">#&gt; 5 Western Australia (((126 -14, 126 -14, 126 -14, 126 -14, 126 -14)), ((124 -16…</span>
<span class="co">#&gt; 6 Tasmania          (((148 -40.3, 148 -40.3, 148 -40.3, 148 -40.3)), ((147 -39.…</span>
<span class="co">#&gt; # … with 3 more rows</span></code></pre></div>
<p>This output shows some of the metadata associated with the data (discussed momentarily), and tells us that the data is essentially a tibble with 9 rows and 2 columns. One advantage to sf data is immediately apparent, we can easily see the overall structure of the data: Australia is comprised of six states and some territories. There are 9 distinct geographical units, so there are 9 rows in this tibble (cf. <code>mi_counties data</code> where there is one row per polygon vertex).</p>
<p>The most important column is <code>geometry</code>, which specifies the spatial geometry for each of the states and territories. Each element in the <code>geometry</code> column is a multipolygon object which, as the name suggests, contains data specifying the vertices of one or more polygons that demark the border of a region. Given data in this format, we can use <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> to draw a serviceable map without specifying any parameters or even explicitly declaring any aesthetics:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">oz_states</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-4-1.png" width="65%" style="max-width: 3.9in"></div>
<p>To understand why this works, note that <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> relies on a <code>geometry</code> aesthetic that is not used elsewhere in ggplot2. This aesthetic can be specified in one of three ways:</p>
<ul>
<li><p>In the simplest case (illustrated above) when the user does nothing,
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> will attempt to map it to a column named <code>geometry</code>.</p></li>
<li><p>If the <code>data</code> argument is an sf object then <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> can automatically
detect a geometry column, even if it’s not called <code>geometry</code>.</p></li>
<li><p>You can specify the mapping manually in the usual way with
<code>aes(geometry = my_column)</code>. This is useful if you have multiple geometry
columns.</p></li>
</ul>
<p>The <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> function governs the map projection, discussed in Section <a href="maps.html#mapproj">6.3</a>.</p>
<div id="layered-maps" class="section level3">
<h3>
<span class="header-section-number">6.2.1</span> Layered maps<a class="anchor" aria-label="anchor" href="#layered-maps"><i class="fas fa-link"></i></a>
</h3>
<p>In some instances you may want to overlay one map on top of another. The ggplot2 package supports this by allowing you to add multiple <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> layers to a plot. As an example, I’ll use the <code>oz_states</code> data to draw the Australian states in different colours, and will overlay this plot with the boundaries of Australian electoral regions. To do this, there are two preprocessing steps to perform. First, I’ll use <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code> to remove the “Other Territories” from the state boundaries.</p>
<p>The code below draws a plot with two map layers: the first uses <code>oz_states</code> to fill the states in different colours, and the second uses <code>oz_votes</code> to draw the electoral boundaries. Second, I’ll extract the electoral boundaries in a simplified form using the <code>ms_simplify()</code> function from the rmapshaper package.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Andy Teucher and Kenton Russell, &lt;em&gt;Rmapshaper: Client for ’Mapshaper’ for ’Geospatial’ Operations&lt;/em&gt;, 2018, &lt;a href="https://CRAN.R-project.org/package=rmapshaper" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=rmapshaper&lt;/a&gt;.&lt;/p&gt;'><sup>21</sup></a></span> This is generally a good idea if the original data set (in this case <code><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">ozmaps::abs_ced</a></code>) is stored at a higher resolution than your plot requires, in order to reduce the time taken to render the plot.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oz_states</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/ozmap_states.html">ozmap_states</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">!=</span> <span class="st">"Other Territories"</span><span class="op">)</span>
<span class="va">oz_votes</span> <span class="op">&lt;-</span> <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">ms_simplify</a></span><span class="op">(</span><span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ced</a></span><span class="op">)</span>
<span class="co">#&gt; Registered S3 method overwritten by 'geojsonlint':</span>
<span class="co">#&gt;   method         from </span>
<span class="co">#&gt;   print.location dplyr</span></code></pre></div>
<p>Now that I have data sets <code>oz_states</code> and <code>oz_votes</code> to represent the state borders and electoral borders respectively, the desired plot can be constructed by adding two <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> layers to the plot:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_states</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_votes</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-6-1.png" width="65%" style="max-width: 3.9in"></div>
<p>It is worth noting that the first layer to this plot maps the <code>fill</code> aesthetic in onto a variable in the data. In this instance the <code>NAME</code> variable is a categorical variable and does not convey any additional information, but the same approach can be used to visualise other kinds of area metadata. For example, if <code>oz_states</code> had an additional column specifying the unemployment level in each state, we could map the <code>fill</code> aesthetic to that variable.</p>
</div>
<div id="geom_sf_label" class="section level3">
<h3>
<span class="header-section-number">6.2.2</span> Labelled maps<a class="anchor" aria-label="anchor" href="#geom_sf_label"><i class="fas fa-link"></i></a>
</h3>
<p>Adding labels to maps is an example of annotating plots (Chapter <a href="annotations.html#annotations">8</a>) and is supported by <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text()</a></code>. For example, while an Australian audience might be reasonably expected to know the names of the Australian states (and are left unlabelled in the plot above) few Australians would know the names of different electorates in the Sydney metropolitan region. In order to draw an electoral map of Sydney, then, we would first need to extract the
map data for the relevant elextorates, and then add the label. The plot below zooms in on the Sydney region by specifying <code>xlim</code> and <code>ylim</code> in <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> and then uses <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label()</a></code> to overlay each electorate with a label:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter electorates in the Sydney metropolitan region</span>
<span class="va">sydney_map</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ced</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="st">"Sydney"</span>, <span class="st">"Wentworth"</span>, <span class="st">"Warringah"</span>, <span class="st">"Kingsford Smith"</span>, <span class="st">"Grayndler"</span>, <span class="st">"Lowe"</span>, 
  <span class="st">"North Sydney"</span>, <span class="st">"Barton"</span>, <span class="st">"Bradfield"</span>, <span class="st">"Banks"</span>, <span class="st">"Blaxland"</span>, <span class="st">"Reid"</span>, 
  <span class="st">"Watson"</span>, <span class="st">"Fowler"</span>, <span class="st">"Werriwa"</span>, <span class="st">"Prospect"</span>, <span class="st">"Parramatta"</span>, <span class="st">"Bennelong"</span>, 
  <span class="st">"Mackellar"</span>, <span class="st">"Greenway"</span>, <span class="st">"Mitchell"</span>, <span class="st">"Chifley"</span>, <span class="st">"McMahon"</span>
<span class="op">)</span><span class="op">)</span>

<span class="co"># draw the electoral map of Sydney</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">sydney_map</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">150.97</span>, <span class="fl">151.3</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">33.98</span>, <span class="op">-</span><span class="fl">33.79</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">NAME</span><span class="op">)</span>, label.padding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"mm"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not</span>
<span class="co">#&gt; give correct results for longitude/latitude data</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-7-1.png" width="65%" style="max-width: 3.9in"></div>
<p>The warning message is worth noting. Internally <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_label()</a></code> uses the function
<code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_point_on_surface()</a></code> from the sf package to place labels, and the warning message
occurs because most algorithms used by sf to compute geometric quantities (e.g., centroids,
interior points) are based on an assumption that the points lie in on a flat two dimensional
surface and parameterised with Cartesian co-ordinates. This assumption is not strictly
warranted, and in some cases (e.g., regions near the poles) calculations that treat
longitude and latitude in this way will give erroneous answers. For this reason, the sf
package produces warning messages when it relies on this approximation.</p>
<!-- HW: worth commenting on warning? "st_point_on_surface may not give correct results for longitude/latitude data" -->
</div>
<div id="adding-other-geoms" class="section level3">
<h3>
<span class="header-section-number">6.2.3</span> Adding other geoms<a class="anchor" aria-label="anchor" href="#adding-other-geoms"><i class="fas fa-link"></i></a>
</h3>
<p>Though <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> is special in some ways, it nevertheless behaves in much the same fashion as any other geom, allowing additional data to be plotted on a map with standard geoms. For example, we may wish to plot the locations of the Australian capital cities on the map using <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point()</a></code>. The code below illustrates how this is done:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oz_capitals</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span> 
  <span class="op">~</span><span class="va">city</span>,           <span class="op">~</span><span class="va">lat</span>,     <span class="op">~</span><span class="va">lon</span>,
  <span class="st">"Sydney"</span>,    <span class="op">-</span><span class="fl">33.8688</span>, <span class="fl">151.2093</span>,  
  <span class="st">"Melbourne"</span>, <span class="op">-</span><span class="fl">37.8136</span>, <span class="fl">144.9631</span>, 
  <span class="st">"Brisbane"</span>,  <span class="op">-</span><span class="fl">27.4698</span>, <span class="fl">153.0251</span>, 
  <span class="st">"Adelaide"</span>,  <span class="op">-</span><span class="fl">34.9285</span>, <span class="fl">138.6007</span>, 
  <span class="st">"Perth"</span>,     <span class="op">-</span><span class="fl">31.9505</span>, <span class="fl">115.8605</span>, 
  <span class="st">"Hobart"</span>,    <span class="op">-</span><span class="fl">42.8821</span>, <span class="fl">147.3272</span>, 
  <span class="st">"Canberra"</span>,  <span class="op">-</span><span class="fl">35.2809</span>, <span class="fl">149.1300</span>, 
  <span class="st">"Darwin"</span>,    <span class="op">-</span><span class="fl">12.4634</span>, <span class="fl">130.8456</span>, 
<span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_votes</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_states</span>, colour <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_capitals</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lon</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-8-1.png" width="65%" style="max-width: 3.9in"></div>
<p>In this example <code>geom_point</code> is used only to specify the locations of the capital cities, but the basic idea can be extended to handle point metadata more generally. For example if the oz_capitals data were to include an additional variable specifying the number of electorates within each metropolitan area, we could encode that data using the <code>size</code> aesthetic.</p>
</div>
</div>
<div id="mapproj" class="section level2">
<h2>
<span class="header-section-number">6.3</span> Map projections<a class="anchor" aria-label="anchor" href="#mapproj"><i class="fas fa-link"></i></a>
</h2>
<p>At the start of the chapter I drew maps by plotting longitude and latitude on a Cartesian plane, as if geospatial data were no different to other kinds of data one might want to plot. To a first approximation this is okay, but it’s not good enough if you care about accuracy. There are two fundamental problems with the approach.</p>
<p>The first issue is the shape of the planet. The Earth is neither a flat plane, nor indeed is it a perfect sphere. As a consequence, to map a co-ordinate value (longitude and latitude) to a location we need to make assumptions about all kinds of things. How ellipsoidal is the Earth? Where is the centre of the planet? Where is the origin point for longitude and latitude? Where is the sea level? How do the tectonic plates move? All these things are relevant, and depending on what assumptions one makes the same co-ordinate can be mapped to locations that are many meters apart. The set of assumptions about the shape of the Earth is referred to as the <strong>geodetic datum</strong> and while it might not matter for some data visualisations, for others it is critical. There are several different choices one might consider: if your focus is North America the “North American Datum” (NAD83) is a good choice, whereas if your perspective is global the “World Geodetic System” (WGS84) is probably better.</p>
<p>The second issue is the shape of your map. The Earth is approximately ellipsoidal, but in most instances your spatial data need to be drawn on a two dimensional plane. It is not possible to map the surface of an ellipsoid to a plane without some distortion or cutting, and you will have to make choices about what distortions you are prepared to accept when drawing a map. This is the job of the <strong>map projection</strong>.</p>
<!-- HW: this discussion is great, and was sorely missing from the previous edition of the book, and indeed my understanding of spatial data when I wrote it -->
<p>Map projections are often classified in terms of the geometric properties that they preserve, e.g.</p>
<ul>
<li><p>Area-preserving projections ensure that regions of equal area on the globe are
drawn with equal area on the map.</p></li>
<li><p>Shape-preserving (or conformal) projections ensure that the local shape of
regions is preserved.</p></li>
</ul>
<p>And unfortunately, it’s not possible for any projection to be shape-preserving and area-preserving. This makes it a little beyond the scope of this book to discuss map projections in detail, other than to note that the simple features specification allows you to indicate which map projection you want to use. For more information on map projections, see Geocomputation with R <a href="https://geocompr.robinlovelace.net/" class="uri">https://geocompr.robinlovelace.net/</a>.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Robin Lovelace, Jakub Nowosad, and Jannes Muenchow, &lt;em&gt;Geocomputation with R&lt;/em&gt; (CRC Press, 2019).&lt;/p&gt;"><sup>22</sup></a></span></p>
<p>Taken together, the geodetic datum (e.g, WGS84), the type of map projection (e.g., Mercator) and the parameters of the projection (e.g., location of the origin) specify a <strong>coordinate reference system</strong>, or CRS, a complete set of assumptions used to translate the latitude and longitude information into a two dimensional map. An sf object often includes a default CRS, as illustrated below:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">oz_votes</span><span class="op">)</span>
<span class="co">#&gt; Coordinate Reference System:</span>
<span class="co">#&gt;   User input: EPSG:4283 </span>
<span class="co">#&gt;   wkt:</span>
<span class="co">#&gt; GEOGCRS["GDA94",</span>
<span class="co">#&gt;     DATUM["Geocentric Datum of Australia 1994",</span>
<span class="co">#&gt;         ELLIPSOID["GRS 1980",6378137,298.257222101,</span>
<span class="co">#&gt;             LENGTHUNIT["metre",1]]],</span>
<span class="co">#&gt;     PRIMEM["Greenwich",0,</span>
<span class="co">#&gt;         ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">#&gt;     CS[ellipsoidal,2],</span>
<span class="co">#&gt;         AXIS["geodetic latitude (Lat)",north,</span>
<span class="co">#&gt;             ORDER[1],</span>
<span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">#&gt;         AXIS["geodetic longitude (Lon)",east,</span>
<span class="co">#&gt;             ORDER[2],</span>
<span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433]],</span>
<span class="co">#&gt;     USAGE[</span>
<span class="co">#&gt;         SCOPE["Horizontal component of 3D system."],</span>
<span class="co">#&gt;         AREA["Australia including Lord Howe Island, Macquarie Islands, Ashmore and Cartier Islands, Christmas Island, Cocos (Keeling) Islands, Norfolk Island. All onshore and offshore."],</span>
<span class="co">#&gt;         BBOX[-60.56,93.41,-8.47,173.35]],</span>
<span class="co">#&gt;     ID["EPSG",4283]]</span></code></pre></div>
<p>Most of this output corresponds to a <strong>well-known text</strong> (WKT) string that unambiguously describes the CRS. This verbose WKT representation is used by sf internally, but there are several ways to provide user input that sf understands. One such method is to provide numeric input in the form of an <strong>EPSG code</strong> (see <a href="http://www.epsg.org/" class="uri">http://www.epsg.org/</a>). The default CRS in the <code>oz_votes</code> data corresponds to EPSG code 4283:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">oz_votes</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4283</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>In ggplot2, the CRS is controlled by <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code>, which ensures that every layer in the plot uses the same projection. By default, <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> uses the CRS associated with the geometry column of the data<a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;If there are multiple data sets with a different associated CRS, it uses the CRS from the first layer.&lt;/p&gt;"><sup>23</sup></a>. Because sf data typically supply a sensible choice of CRS, this process usually unfolds invisibly, requiring no intervention from the user. However, should you need to set the CRS yourself, you can specify the <code>crs</code> parameter by passing valid user input to <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code>. The example below illustrates how to switch from the default CRS to EPSG code 3112:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">oz_votes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">oz_votes</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">3112</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="maps_files/figure-html/unnamed-chunk-11-1.png" width="50%" style="max-width: 3in"><img src="maps_files/figure-html/unnamed-chunk-11-2.png" width="50%" style="max-width: 3in"></p>
</div>
<div id="sfdetail" class="section level2">
<h2>
<span class="header-section-number">6.4</span> Working with sf data<a class="anchor" aria-label="anchor" href="#sfdetail"><i class="fas fa-link"></i></a>
</h2>
<p>As noted earlier, maps created using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf()</a></code> rely heavily on tools
provided by the sf package, and indeed the sf package contains many more useful tools for
manipulating simple features data. In this section I provide an introduction to a few
such tools; more detailed coverage can be found on the sf package website
<a href="https://r-spatial.github.io/sf/" class="uri">https://r-spatial.github.io/sf/</a>.</p>
<p>To get started, recall that one advantage to simple features over other representations
of spatial data is that geographical units can have complicated structure. A good example
of this in the Australian maps data is the electoral district of Eden-Monaro, plotted below:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edenmonaro</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ced</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"Eden-Monaro"</span><span class="op">)</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">edenmonaro</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">147.75</span>, <span class="fl">150.25</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">37.5</span>, <span class="op">-</span><span class="fl">34.5</span><span class="op">)</span><span class="op">)</span> 
<span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">150.25</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">36.3</span>, <span class="op">-</span><span class="fl">36</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p><img src="maps_files/figure-html/unnamed-chunk-12-1.png" width="50%" style="max-width: 3in"><img src="maps_files/figure-html/unnamed-chunk-12-2.png" width="50%" style="max-width: 3in"></p>
<p>As this illustrates, Eden-Monaro is defined in terms of two distinct polygons, a large one on the Australian mainland and a small island. However, the large region has a hole in the middle (the hole exists because the Australian Capital Territory is a distinct political unit that is wholly contained within Eden-Monaro, and as illustrated above, electoral boundaries in Australia do not cross state lines). In sf terminology this is an example of a <code>MULTIPOLYGON</code> geometry. In this section I’ll talk about the structure of these objects and how to work with them.</p>
<p>First, let’s use dplyr to grab only the geometry object:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edenmonaro</span> <span class="op">&lt;-</span> <span class="va">edenmonaro</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span></code></pre></div>
<p>The metadata for the edenmonaro object can accessed using helper functions. For example, <code><a href="https://r-spatial.github.io/sf/reference/st_geometry_type.html">st_geometry_type()</a></code> extracts the geometry type (e.g., <code>MULTIPOLYGON</code>), <code><a href="https://r-spatial.github.io/sf/reference/geos_query.html">st_dimension()</a></code> extracts the number of dimensions (2 for XY data, 3 for XYZ), <code><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox()</a></code> extracts the bounding box as a numeric vector, and <code><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs()</a></code> extracts the CRS as a list with two components, one for the EPSG code and the other for the proj4string. For example:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">edenmonaro</span><span class="op">)</span>
<span class="co">#&gt;  xmin  ymin  xmax  ymax </span>
<span class="co">#&gt; 147.7 -37.5 150.2 -34.5</span></code></pre></div>
<p>Normally when we print the <code>edenmonaro</code> object the output would display all the additional information (dimension, bounding box, geodetic datum etc) but for the remainder of this section I will show only the relevant lines of the output. In this case edenmonaro is defined by a MULTIPOLYGON geometry containing one feature:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edenmonaro</span> 
<span class="co">#&gt; Geometry set for 1 feature </span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; MULTIPOLYGON (((150 -36.2, 150 -36.2, 150 -36.3...</span></code></pre></div>
<p>However, we can “cast” the MULTIPOLYGON into the two distinct POLYGON geometries from which it is constructed using <code><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast()</a></code>:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">edenmonaro</span>, <span class="st">"POLYGON"</span><span class="op">)</span>
<span class="co">#&gt; Geometry set for 2 features </span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; POLYGON ((150 -36.2, 150 -36.2, 150 -36.3, 150 ...</span>
<span class="co">#&gt; POLYGON ((148 -36.7, 148 -36.7, 148 -36.7, 148 ...</span></code></pre></div>
<p>To illustrate when this might be useful, consider the Dawson electorate, which consists of 69 islands in addition to a coastal region on the Australian mainland.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dawson</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ced</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"Dawson"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span>
<span class="va">dawson</span>
<span class="co">#&gt; Geometry set for 1 feature </span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; MULTIPOLYGON (((148 -19.9, 148 -19.8, 148 -19.8...</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dawson</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-17-1.png" width="50%" style="max-width: 3in"></div>
<p>Suppose, however, our interest is only in mapping the islands. If so, we can first use the <code><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast()</a></code> function to break the Dawson electorate into the constituent polygons. After doing so, we can use <code><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area()</a></code> to calculate the area of each polygon and <code><a href="https://rdrr.io/r/base/which.min.html">which.max()</a></code> to find the polygon with maximum area:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dawson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html">st_cast</a></span><span class="op">(</span><span class="va">dawson</span>, <span class="st">"POLYGON"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html">st_area</a></span><span class="op">(</span><span class="va">dawson</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] 69</span></code></pre></div>
<p>The large mainland region corresponds to the 69th polygon within Dawson. Armed with this knowledge, we can draw a map showing only the islands:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">dawson</span><span class="op">[</span><span class="op">-</span><span class="fl">69</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-19-1.png" width="50%" style="max-width: 3in"></div>
</div>
<div id="rastermaps" class="section level2">
<h2>
<span class="header-section-number">6.5</span> Raster maps<a class="anchor" aria-label="anchor" href="#rastermaps"><i class="fas fa-link"></i></a>
</h2>
<!-- HW: do you have any thoughts on a modern approach to this problem? -->
<p>A second way to supply geospatial information for mapping is to rely on <strong>raster data</strong>. Unlike the simple features format, in which geographical entities are specified in terms of a set of lines, points and polygons, rasters take the form of images. In the simplest case raster data might be nothing more than a bitmap file, but there are many different image formats out there. In the geospatial context specifically, there are image formats that include metadata (e.g., geodetic datum, coordinate reference system) that can be used to map the image information to the surface of the Earth. For example, one common format is GeoTIFF, which is a regular TIFF file with additional metadata supplied. Happily, most formats can be easily read into R with the assistance of GDAL (the Geospatial Data Abstraction Library, <a href="https://gdal.org/" class="uri">https://gdal.org/</a>). For example the sf package contains a function <code><a href="https://r-spatial.github.io/sf/reference/gdal.html">sf::gdal_read()</a></code> that provides access to the GDAL raster drivers from R. However, you rarely need to call this function directly, as there are other high level functions that take care of this for you.</p>
<p>As an illustration, suppose we wish to plot satellite images made publicly available by the Australian Bureau of Meterorology (BOM) on their FTP server. The bomrang package<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Adam H Sparks et al., “bomrang: Fetch Australian Government Bureau of Meteorology Weather Data,” &lt;em&gt;The Journal of Open Source Software&lt;/em&gt; 2, no. 17 (September 2017), &lt;a href="https://doi.org/10.21105/joss.00411" role="doc-biblioref"&gt;https://doi.org/10.21105/joss.00411&lt;/a&gt;.&lt;/p&gt;'><sup>24</sup></a></span> provides a convenient interface to the server, including a <code>get_available_imagery()</code> function that returns a vector of filenames and a <code>get_satellite_imagery()</code> function that downloads a file and imports it directly into R. For expository purposes, however, I’ll use a more flexible method that could be adapted to any FTP server, and use the <code><a href="https://rdrr.io/r/utils/download.file.html">download.file()</a></code> function:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># list of all file names with time stamp 2020-01-07 21:00 GMT </span>
<span class="co"># (BOM images are retained for 24 hours, so this will return an</span>
<span class="co"># empty vector if you run this code without editing the time stamp)</span>
<span class="va">files</span> <span class="op">&lt;-</span> <span class="fu">bomrang</span><span class="fu">::</span><span class="fu">get_available_imagery</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
  <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="st">"202001072100"</span><span class="op">)</span> 

<span class="co"># use curl_download() to obtain a single file, and purrr to </span>
<span class="co"># vectorise this operation</span>
<span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">walk2</a></span><span class="op">(</span>
  .x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"ftp://ftp.bom.gov.au/anon/gen/gms/"</span>, <span class="va">files</span><span class="op">)</span>,
  .y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"raster"</span>, <span class="va">files</span><span class="op">)</span>,
  .f <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="va">.x</span>, destfile <span class="op">=</span> <span class="va">.y</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>Note that if you want to run this code yourself you will need to change the time stamp string from <code>"202001072100"</code> to one day prior to the current date, and you will need to make sure there is a folder called “raster” in your working directory into which files will be downloaded. After caching the files locally (which is generally a good idea) we can inspect the list of files we have downloaded:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="st">"raster"</span><span class="op">)</span>
<span class="co">#&gt; [1] "IDE00421.202001072100.tif" "IDE00422.202001072100.tif"</span></code></pre></div>
<p>All 14 files are constructed from images taken by the Himawari-8 geostationary satellite operated by the Japan Meteorological Agency and takes images across 13 distinct bands. The images released by the Australian BOM include data on the visible spectrum (channel 3) and the infrared spectrum (channel 13):</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">img_vis</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"raster"</span>, <span class="st">"IDE00422.202001072100.tif"</span><span class="op">)</span>
<span class="va">img_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"raster"</span>, <span class="st">"IDE00421.202001072100.tif"</span><span class="op">)</span></code></pre></div>
<p>To import the data in the img_visible file into R, I’ll use the stars package<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Edzer Pebesma, &lt;em&gt;Stars: Spatiotemporal Arrays, Raster and Vector Data Cubes&lt;/em&gt;, 2020.&lt;/p&gt;"><sup>25</sup></a></span> to import the data as stars objects:</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="va">sat_vis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">img_vis</span>, RasterIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nBufXSize <span class="op">=</span> <span class="fl">600</span>, nBufYSize <span class="op">=</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span>
<span class="va">sat_inf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">img_inf</span>, RasterIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nBufXSize <span class="op">=</span> <span class="fl">600</span>, nBufYSize <span class="op">=</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>In the code above, the first argument specifies the path to the raster file, and the <code>RasterIO</code> argument is used to pass a list of low-level parameters to GDAL. In this case, I have used <code>nBufXSize</code> and <code>nBufYSize</code> to ensure that R reads the data at low resolution (as a 600x600 pixel image). To see what information R has imported, we can inspect the <code>sat_vis</code> object:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sat_vis</span>
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s), summary of first 1e+05 cells:</span>
<span class="co">#&gt;                            Min. 1st Qu. Median Mean 3rd Qu. Max.</span>
<span class="co">#&gt; IDE00422.202001072100.tif     0       0      0 18.1       0  255</span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to   offset    delta                  refsys point values x/y</span>
<span class="co">#&gt; x       1 600 -5500000  18333.3 Geostationary_Satellite FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 600  5500000 -18333.3 Geostationary_Satellite FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   3       NA       NA                      NA    NA   NULL</span></code></pre></div>
<p>This output tells us something about the structure of a stars object. For the <code>sat_vis</code> object the underlying data is stored as a three dimensional array, with <code>x</code> and <code>y</code> dimensions specifying the spatial data. The <code>band</code> dimension in this case corresponds to the colour channel (RGB) but is redundant for this image as the data are greyscale. In other data sets there might be bands corresponding to different sensors, and possibly a time dimension as well. Note that the spatial data is also associated with a coordinate reference system (referred to as “refsys” in the output).</p>
<p>To plot the <code>sat_vis</code> data in ggplot2, we can use the <code><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars()</a></code> function provided by the stars package. A minimal plot might look like this:</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sat_vis</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-25-1.png" width="100%" style="max-width: 6in"></div>
<p>The <code><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars()</a></code> function requires the <code>data</code> argument to be a stars object, and maps the raster data to the fill aesthetic. Accordingly, the blue shading in the satellite image above is determined by the ggplot2 scale, not the image itself. That is, although <code>sat_vis</code> contains three bands, the plot above only displays the first one, and the raw data values (which range from 0 to 255) are mapped onto the default blue palette that ggplot2 uses for continuous data. To see what the image file “really” looks like we can separate the bands using <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap()</a></code>:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sat_vis</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">band</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"black"</span>, high <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-26-1.png" width="100%" style="max-width: 6in"></div>
<p>One limitation to displaying only the raw image is that it is not easy to work out where the relevant landmasses are, and we may wish to overlay the satellite data with the <code>oz_states</code> vector map to show the outlines of Australian political entities. However, some care is required in doing so because the two data sources are associated with different coordinate reference systems. To project the <code>oz_states</code> data correctly, the data should be transformed using the <code><a href="https://r-spatial.github.io/stars/reference/st_transform.html">st_transform()</a></code> function from the sf package. In the code below, I extract the CRS from the <code>sat_vis</code> raster object, and transform the <code>oz_states</code> data to use the same system.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oz_states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">oz_states</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">sat_vis</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Having done so, I can now draw the vector map over the top of the raster image to make the image more interpretable to the reader. It is now clear from inspection that the satellite image was taken during the Australian sunrise:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sat_vis</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_states</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"black"</span>, high <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-28-1.png" width="100%" style="max-width: 6in"></div>
<p>What if we wanted to plot more conventional data over the top? A simple example of this would be to plot the locations of the Australian capital cities per the <code>oz_capitals</code> data frame that contains latitude and longitude data. However, because these data are not associated with a CRS and are not on the same scale as the raster data in <code>sat_vis</code>, these will <em>also</em> need to be transformed. To do so, we first need to create an sf object from the <code>oz_capitals</code> data using <code><a href="https://r-spatial.github.io/stars/reference/st_as_sf.html">st_as_sf()</a></code>:</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cities</span> <span class="op">&lt;-</span> <span class="va">oz_capitals</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span>, remove <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>This projection is set using the EPSG code 4326, an ellipsoidal projection using the latitude and longitude values as co-ordinates and relying on the WGS84 datum. Having done so we can now transform the co-ordinates from the latitude-longitude geometry to the match the geometry of our <code>sat_vis</code> data:</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">cities</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">sat_vis</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The transformed data can now be overlaid using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf()</a></code>:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://r-spatial.github.io/stars/reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sat_vis</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">oz_states</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cities</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"black"</span>, high <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="maps_files/figure-html/unnamed-chunk-31-1.png" width="100%" style="max-width: 6in"></div>
<p>This version of the image makes clearer that the satellite image was taken at approximately sunrise in Darwin: the sun had risen for all the eastern cities but not in Perth. This could be made clearer in the data visualisation using the <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text()</a></code> function to add labels to each city. For instance we could add another layer to the plot using code like this,</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cities</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">city</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>though some care would be required to ensure the text is positioned nicely (see Chapter <a href="annotations.html#annotations">8</a>).</p>
</div>
<div id="data-sources" class="section level2">
<h2>
<span class="header-section-number">6.6</span> Data sources<a class="anchor" aria-label="anchor" href="#data-sources"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li><p>The USAboundaries package, <a href="https://github.com/ropensci/USAboundaries" class="uri">https://github.com/ropensci/USAboundaries</a> contains state, county and zip code data for the US.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Lincoln A. Mullen and Jordan Bratt, “USAboundaries: Historical and Contemporary Boundaries of the United States of America,” &lt;em&gt;Journal of Open Source Software&lt;/em&gt; 3, no. 23 (2018): 314, &lt;a href="https://doi.org/10.21105/joss.00314" role="doc-biblioref"&gt;https://doi.org/10.21105/joss.00314&lt;/a&gt;.&lt;/p&gt;'><sup>26</sup></a></span> As well as current boundaries, it also has state and county boundaries going back to the 1600s.</p></li>
<li><p>The tigris package, <a href="https://github.com/walkerke/tigris" class="uri">https://github.com/walkerke/tigris</a>, makes it easy to access the US Census TIGRIS shapefiles.<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Kyle Walker, &lt;em&gt;Tigris: Load Census Tiger/Line Shapefiles&lt;/em&gt;, 2019, &lt;a href="https://CRAN.R-project.org/package=tigris" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=tigris&lt;/a&gt;.&lt;/p&gt;'><sup>27</sup></a></span> It contains state, county, zipcode, and census tract boundaries, as well as many other useful datasets.</p></li>
<li><p>The rnaturalearth package<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Andy South, &lt;em&gt;Rnaturalearth: World Map Data from Natural Earth&lt;/em&gt;, 2017, &lt;a href="https://CRAN.R-project.org/package=rnaturalearth" role="doc-biblioref"&gt;https://CRAN.R-project.org/package=rnaturalearth&lt;/a&gt;.&lt;/p&gt;'><sup>28</sup></a></span> bundles up the free, high-quality data from <a href="http://naturalearthdata.com/" class="uri">http://naturalearthdata.com/</a>. It contains country borders, and borders for the top-level region within each country (e.g. states in the USA, regions in France, counties in the UK).</p></li>
<li><p>The osmar package, <a href="https://cran.r-project.org/package=osmar" class="uri">https://cran.r-project.org/package=osmar</a> wraps up the OpenStreetMap API so you can access a wide range of vector data including individual streets and buildings<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content='&lt;p&gt;Manuel J. A. Eugster and Thomas Schlesinger, “Osmar: OpenStreetMap and R,” &lt;em&gt;R Journal&lt;/em&gt;, 2010, &lt;a href="http://osmar.r-forge.r-project.org/RJpreprint.pdf" role="doc-biblioref"&gt;http://osmar.r-forge.r-project.org/RJpreprint.pdf&lt;/a&gt;.&lt;/p&gt;'><sup>29</sup></a></span></p></li>
<li><p>If you have your own shape files (<code>.shp</code>) you can load them into R with <code><a href="https://r-spatial.github.io/sf/reference/st_read.html">sf::read_sf()</a></code></p></li>
</ul>
</div>
</div>

  <div class="chapter-nav">
<div class="prev"><a href="statistical-summaries.html"><span class="header-section-number">5</span> Statistical summaries</a></div>
<div class="next"><a href="networks.html"><span class="header-section-number">7</span> Networks</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#maps"><span class="header-section-number">6</span> Maps</a></li>
<li><a class="nav-link" href="#polygonmaps"><span class="header-section-number">6.1</span> Polygon maps</a></li>
<li>
<a class="nav-link" href="#sf"><span class="header-section-number">6.2</span> Simple features maps</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#layered-maps"><span class="header-section-number">6.2.1</span> Layered maps</a></li>
<li><a class="nav-link" href="#geom_sf_label"><span class="header-section-number">6.2.2</span> Labelled maps</a></li>
<li><a class="nav-link" href="#adding-other-geoms"><span class="header-section-number">6.2.3</span> Adding other geoms</a></li>
</ul>
</li>
<li><a class="nav-link" href="#mapproj"><span class="header-section-number">6.3</span> Map projections</a></li>
<li><a class="nav-link" href="#sfdetail"><span class="header-section-number">6.4</span> Working with sf data</a></li>
<li><a class="nav-link" href="#rastermaps"><span class="header-section-number">6.5</span> Raster maps</a></li>
<li><a class="nav-link" href="#data-sources"><span class="header-section-number">6.6</span> Data sources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/hadley/ggplot2-book/blob/master/maps.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/hadley/ggplot2-book/edit/master/maps.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>ggplot2</strong>: Elegant Graphics for Data Analysis" was written by Hadley Wickham, Danielle Navarro, and Thomas Lin Pedersen. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
